# תיעוד תכונת Portfolio (תיק השקעות)

## סקירה כללית

תכונת Portfolio מאפשרת למשתמשים לנהל את תיק ההשקעות שלהם במניות. המערכת עוקבת אחר המניות שברשות המשתמש, מחשבת רווח והפסד בזמן אמת, ומציגה סיכום כולל של התיק.

---

## פעולות זמינות

### 1. **צפייה בתיק ההשקעות** 📊
- **מה זה עושה**: מציג את כל המניות בתיק שלך עם פרטים מלאים
- **איך להשתמש**: הכניסה לדשבורד תציג את ווידג'ט ה-Portfolio
- **מה תראה**:
  - טבלה עם כל המניות שלך
  - סיכום כולל: ערך כולל, רווח/הפסד כולל
  - לכל מניה: סמל, מספר מניות, מחיר ממוצע, מחיר נוכחי, רווח/הפסד

### 2. **הוספת מניה חדשה לתיק** ➕
- **מה זה עושה**: מוסיף מניה חדשה לתיק ההשקעות שלך
- **איך להשתמש**:
  1. לחץ על כפתור "Add Stock" (הוסף מניה)
  2. מלא את הפרטים:
     - **Symbol** (סמל): סמל המניה (למשל: AAPL, GOOGL, MSFT)
     - **Shares** (מספר מניות): כמה מניות קנית
     - **Average Price** (מחיר ממוצע): המחיר הממוצע שבו קנית
  3. לחץ על "Add to Portfolio"
- **מה קורה מאחורי הקלעים**:
  - המערכת מביאה את המחיר הנוכחי של המניה
  - מחשבת אוטומטית את הרווח/הפסד
  - מעדכנת את הסיכום הכולל של התיק

### 3. **עדכון מניה קיימת** ✏️
- **מה זה עושה**: מאפשר לעדכן את מספר המניות או את המחיר הממוצע של מניה קיימת
- **איך להשתמש**:
  1. לחץ על כפתור העריכה (✏️) ליד המניה שברצונך לערוך
  2. עדכן את השדות:
     - **Shares**: מספר המניות
     - **Average Price**: המחיר הממוצע
  3. לחץ על ✓ לשמירה או X לביטול
- **מה קורה מאחורי הקלעים**:
  - המערכת מעדכנת את הנתונים
  - מחשבת מחדש את הרווח/הפסד
  - מעדכנת את המחיר הנוכחי

### 4. **הוספת מניות נוספות למניה קיימת** 📈
- **מה זה עושה**: אם יש לך כבר מניה מסוימת, הוספת מניות נוספות תחשב מחדש את המחיר הממוצע המשוקלל
- **איך להשתמש**: פשוט הוסף את אותה מניה שוב עם מספר המניות והמחיר החדש
- **דוגמה**:
  - יש לך 10 מניות של AAPL במחיר ממוצע של $150
  - אתה קונה עוד 5 מניות ב-$160
  - המערכת תחשב מחדש: (10×150 + 5×160) / 15 = $153.33
  - המחיר הממוצע החדש יהיה $153.33

### 5. **מחיקת מניה מהתיק** 🗑️
- **מה זה עושה**: מסיר מניה מהתיק שלך
- **איך להשתמש**:
  1. לחץ על כפתור המחיקה (🗑️) ליד המניה שברצונך למחוק
  2. אשר את המחיקה בחלון האישור
- **הערה**: פעולה זו אינה הפיכה - תצטרך להוסיף את המניה מחדש אם תרצה

---

## מה המערכת מחשבת אוטומטית

### 1. **מחיר נוכחי** 💰
- המערכת מביאה את המחיר הנוכחי של כל מניה מ-Finnhub או Polygon.io
- המחיר מתעדכן אוטומטית כל 2 דקות

### 2. **רווח/הפסד (Gain/Loss)** 📊
- **חישוב**: `(מחיר נוכחי - מחיר ממוצע) × מספר מניות`
- **אחוז רווח/הפסד**: `((מחיר נוכחי - מחיר ממוצע) / מחיר ממוצע) × 100`
- **צבעים**:
  - 🟢 ירוק = רווח
  - 🔴 אדום = הפסד

### 3. **סיכום כולל** 📈
- **ערך כולל**: סכום כל המניות במחיר הנוכחי
- **עלות כוללת**: סכום כל המניות במחיר הממוצע
- **רווח/הפסד כולל**: ההפרש בין הערך הכולל לעלות הכוללת
- **אחוז רווח/הפסד כולל**: אחוז הרווח/הפסד של כל התיק

---

## מבנה הנתונים

### PortfolioEntry (עמודה בתיק)
```typescript
{
  userId: string          // מזהה המשתמש
  symbol: string         // סמל המניה (AAPL, GOOGL, וכו')
  shares: number         // מספר המניות
  averagePrice: number   // מחיר ממוצע
  currentPrice: number   // מחיר נוכחי (מתעדכן אוטומטית)
  gainLoss: number       // רווח/הפסד בדולרים
  gainLossPercent: number // רווח/הפסד באחוזים
  createdAt: Date        // תאריך יצירה
  updatedAt: Date        // תאריך עדכון אחרון
}
```

### PortfolioSummary (סיכום התיק)
```typescript
{
  totalValue: number           // ערך כולל של התיק
  totalCost: number            // עלות כוללת
  totalGainLoss: number        // רווח/הפסד כולל
  totalGainLossPercent: number // אחוז רווח/הפסד כולל
}
```

---

## API Endpoints (נקודות קצה)

### 1. **GET /api/portfolio**
- **תיאור**: מקבל את כל המניות בתיק
- **תגובה**: רשימת מניות + סיכום כולל
- **אימות**: נדרש (רק משתמש מחובר)

### 2. **POST /api/portfolio**
- **תיאור**: מוסיף מניה חדשה או מעדכן מניה קיימת
- **פרמטרים**:
  ```json
  {
    "symbol": "AAPL",
    "shares": 10,
    "averagePrice": 150.00
  }
  ```
- **תגובה**: המניה שנוספה/עודכנה

### 3. **PUT /api/portfolio/:symbol**
- **תיאור**: מעדכן מניה קיימת
- **פרמטרים** (לפחות אחד נדרש):
  ```json
  {
    "shares": 15,        // אופציונלי
    "averagePrice": 155.00  // אופציונלי
  }
  ```
- **תגובה**: המניה המעודכנת

### 4. **DELETE /api/portfolio/:symbol**
- **תיאור**: מוחק מניה מהתיק
- **פרמטרים**: סמל המניה ב-URL
- **תגובה**: הודעת אישור

---

## תכונות טכניות

### 1. **עדכון אוטומטי של מחירים**
- המערכת מעדכנת את המחירים כל 2 דקות
- משתמשת ב-Finnhub כ-source ראשי, ו-Polygon.io כגיבוי

### 2. **חישוב מחיר ממוצע משוקלל**
- כאשר מוסיפים מניות נוספות למניה קיימת, המערכת מחשבת מחדש את המחיר הממוצע
- הנוסחה: `(מניות ישנות × מחיר ישן + מניות חדשות × מחיר חדש) / (מניות ישנות + מניות חדשות)`

### 3. **Caching (מטמון)**
- הנתונים נשמרים במטמון למשך 2 דקות
- זה משפר את הביצועים ומפחית קריאות API

### 4. **Real-time Updates (עדכונים בזמן אמת)**
- המחירים מתעדכנים אוטומטית
- הרווח/הפסד מחושב מחדש בכל עדכון

---

## דוגמאות שימוש

### דוגמה 1: הוספת מניה חדשה
```
1. לחץ על "Add Stock"
2. הזן: Symbol = "AAPL", Shares = 10, Average Price = 150
3. המערכת תציג:
   - Current Price: $175 (מחיר נוכחי)
   - Gain/Loss: $250 (רווח)
   - Gain/Loss %: 16.67%
```

### דוגמה 2: עדכון מניה קיימת
```
1. יש לך 10 מניות AAPL במחיר ממוצע $150
2. לחץ על כפתור העריכה
3. שנה את מספר המניות ל-15
4. המערכת תעדכן את הרווח/הפסד בהתאם
```

### דוגמה 3: הוספת מניות נוספות
```
1. יש לך 10 מניות AAPL במחיר ממוצע $150
2. הוסף עוד 5 מניות במחיר $160
3. המערכת תחשב:
   - מניות חדשות: 15
   - מחיר ממוצע חדש: $153.33
   - רווח/הפסד מחושב מחדש
```

---

## קבצים רלוונטיים

### Frontend (לקוח)
- `client/src/components/widgets/portfolio.tsx` - רכיב ה-UI של התיק
- `client/src/hooks/api/use-portfolio.ts` - Hooks לניהול הנתונים
- `client/src/lib/api/portfolio.api.ts` - קריאות API

### Backend (שרת)
- `server/src/api/routes/portfolio.routes.ts` - נתיבי API
- `server/src/api/controllers/portfolio.controller.ts` - בקרים
- `server/src/services/portfolio.service.ts` - לוגיקת עסקים
- `server/src/db/schema/portfolio.ts` - סכמת מסד הנתונים

---

## הערות חשובות

1. **אימות**: כל הפעולות דורשות התחברות (authentication)
2. **מחירים**: המחירים מתעדכנים כל 2 דקות, לא בזמן אמת מלא
3. **מניות בלבד**: כרגע התיק תומך רק במניות, לא בקריפטו או נכסים אחרים
4. **מחיר ממוצע**: כאשר מוסיפים מניות נוספות, המחיר הממוצע מחושב מחדש אוטומטית
5. **מחיקה**: מחיקת מניה היא פעולה קבועה - לא ניתן לבטל

---

## שאלות נפוצות

**Q: איך אני מוסיף מניה?**  
A: לחץ על "Add Stock", מלא את הפרטים ולחץ "Add to Portfolio".

**Q: איך אני מעדכן את מספר המניות?**  
A: לחץ על כפתור העריכה (✏️) ליד המניה, עדכן את השדות ולחץ ✓.

**Q: מה קורה אם אני מוסיף את אותה מניה פעמיים?**  
A: המערכת תחשב מחדש את המחיר הממוצע המשוקלל ותעדכן את מספר המניות.

**Q: כמה זמן לוקח לעדכן את המחירים?**  
A: המחירים מתעדכנים כל 2 דקות אוטומטית.

**Q: האם אני יכול לראות היסטוריה של עסקאות?**  
A: כרגע לא - המערכת מציגה רק את המצב הנוכחי של התיק.

---

## סיכום

תכונת Portfolio מספקת כלי נוח וחזק לניהול תיק השקעות במניות. היא מאפשרת:
- ✅ מעקב אחר מניות
- ✅ חישוב אוטומטי של רווח/הפסד
- ✅ עדכון מחירים אוטומטי
- ✅ סיכום כולל של התיק
- ✅ ניהול קל ונוח

כל הפעולות מאובטחות ודורשות התחברות, והנתונים נשמרים בבסיס הנתונים שלך.

